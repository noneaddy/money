# Mobile Security Framework (MobSF) Configuration

***

## Requirements

### Static Analysis
* Python 2.7 - [Python 2 Download](https://www.python.org/downloads/) (Latest Python 2.7 release is recommended)
* Oracle JDK 1.7 or above - [Java JDK Download](http://www.oracle.com/technetwork/java/javase/downloads/)
* Mac OSX Users must install Command-line tools for MAC OS X - [How to Install Commandline Tools in Mac](http://osxdaily.com/2014/02/12/install-command-line-tools-mac-os-x/)
* iOS IPA Analysis works only on OSX and requires a MAC
* Windows App Static analysis requires a Windows Host or Windows VM for Mac and Linux. For Windows App Static Analysis, Read [Windows App Static Analysis](https://github.com/MobSF/Mobile-Security-Framework-MobSF/blob/master/install/windows/readme.md)
 
**NOTE:**
* On Linux and Mac, install Oracle Java 1.7 or above and **make it the default** one.
* On Linux, make sure you have 32 bit execution support enabled.

### Dynamic Analysis
* MobSF x86 Android VM requires Oracle VirtualBox - [VirtualBox Download](https://www.virtualbox.org/wiki/Downloads)
* [Android Studio](https://developer.android.com/studio/index.html) and a configured virtual device is required if your using MobSF ARM Emulator. Intel HAXM is recommended.
* Hardware Requirements: Min 4GB RAM, 5GB HDD/SSD and Virtualisation Support for running MobSF VM


## Downloads

* Download MobSF Android x86 4.4.2 VM (v0.3) ova file: [https://goo.gl/QxgHZa](https://goo.gl/QxgHZa)
* Download MobSF Android arm Emulator 4.1.2 (v1.0) file [https://goo.gl/LRrGs3](https://goo.gl/LRrGs3)
* No Access to Google Drive? Unofficial MobSF VM 0.2 ova file: [https://pan.baidu.com/s/1jIzBsgA](https://pan.baidu.com/s/1jIzBsgA)

## Installation

**Tested on Windows (7, 8, 8.1, 10), Kali (2016.2), Ubuntu (14.04) , OSX (Mavericks, Yosemite, El Capitan, Sierra)**

* **Windows**: Clone MobSF Repository to C:\
* **Mac**: Clone MobSF Repository to /Users/[username]/
* **Linux**: Clone MobSF Repository to /home/[username]/

```git clone https://github.com/MobSF/Mobile-Security-Framework-MobSF.git```

## Configuring Static Analyzer

```cd Mobile-Security-Framework-MobSF```

Install MobSF Python dependencies using **pip**

#### Windows
`C:\Python27\python.exe -m pip install -r requirements.txt`

**NOTE**: If you face any issues, download and install the latest python 2.7.x

#### Mac
`pip install -r requirements.txt --user`

#### Linux

```
sudo apt install build-essential libssl-dev libffi-dev python-dev
pip install -r requirements.txt --user
```


##### PDF Report Generation

* You need to install `wkhtmltopdf` binary separately for generating PDF reports.
* Check [wkhtmltopdf downloads](http://wkhtmltopdf.org/downloads.html) and 
[Installing wkhtmltopdf wiki](https://github.com/JazzCore/python-pdfkit/wiki/Installing-wkhtmltopdf) for more information.
* In Windows, you need to add the folder that contains `wkhtmltopdf` binary to environment variable PATH.
## Running MobSF

`python manage.py runserver`

If you need to run on a specific port number try  `python manage.py runserver PORT_NO`.
To expose MobSF to a particular IP, you can try `python manage.py runserver IP:PORT_NO`.

If everything goes right, you will get an output like the one below.

![Mobile Security Framework (MobSF) Running](https://cloud.githubusercontent.com/assets/4301109/21996120/aca05004-dc4e-11e6-849f-1ed73ea8a34c.png)

You can navigate to `http://localhost:8000/` to access the MobSF Web interface.

***

## Configuring Dynamic Analyzer

MobSF Dynamic Analysis currently supports Android and can be done in four ways.

1. [Dynamic Analysis with MobSF Android 4.4.2 x86 VirtualBox VM - **default** (Fast, not all Apps work)](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/1.-Documentation/#configuring-dynamic-analyzer-with-mobsf-android-442-x86-virtualbox-vm)
2. [Dynamic Analysis with MobSF Android 4.1.2 arm Emulator - (Slow, Most Apps work)](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/1.-Documentation/#configuring-dynamic-analyzer-with-with-mobsf-android-412-arm-emulator)
3. [Dynamic Analysis using a Rooted Android 4.03 - 4.4 Device (Very Fast, All Apps work)](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/1.-Documentation/#configuring-dynamic-analyzer-with-rooted-android-403---44-device)
4. [Dynamic Analysis using a Rooted Android 4.03 - 4.4 VM (not tested)](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/1.-Documentation#configuring-dynamic-analyzer-with-rooted-android-403---44-vm)

### Configuring Dynamic Analyzer with MobSF Android 4.4.2 x86 VirtualBox VM

Dynamic Anlayzer is available only for Android binaries (APK) and works only if your computer has at least 4GB of RAM and Full Virtualization support.

To Configure Dynamic Analyzer we need 4 things.
* VM UUID
* Snapshot UUID
* Host/Proxy IP
* VM/Device IP
 
#### Steps to Follow

* Open VirtualBox, Go to **File -> Import Appliance** and select the MobSF_VM_X.X.ova file.
  
  ![Importing MobSF VM ova file](https://cloud.githubusercontent.com/assets/4301109/9768972/cbdd115e-5744-11e5-88dc-bf280df3a963.png)

* Proceed with the import process. Do not alter anything.
* Once the OVA is Imported Successfully, you will see a new entry in VirtualBox named MobSF_VM_X.X
* Right Click MobSF VM and Choose Settings, Go to Network tab. Here we need to configure two Network Adapters.
  
  * **Adapter** 1 should be enabled and attached to **Host-only Adapter**. Remember the name of the adapter. We need the name to Identify the Host/Proxy IP.
    
    ![Adapter 1](https://cloud.githubusercontent.com/assets/4301109/9769043/2852d5b8-5745-11e5-9da4-0d76c18ecc3b.png)
  
  * **Adapter 2** should be enabled and attached to **NAT**
    
    ![Adapter 2](https://cloud.githubusercontent.com/assets/4301109/9769162/14556a70-5746-11e5-8d76-ce8d6d200167.png)

* Save the settings and Start MobSF VM. While the VM is Booting up. Note down the **VM IP**.
  
  ![VM IP](https://cloud.githubusercontent.com/assets/4301109/9769219/794771da-5746-11e5-9d81-5549422aac71.png)
* Once the VM Boots up, It will present a Lock Screen. The password for the Lock Screen is `1234`
  
  ![MobSF VM](https://cloud.githubusercontent.com/assets/4301109/9769278/c35e0f90-5746-11e5-9d07-75c1c63e8cdb.png)
  
  **NOTE**: If the VM does not boot up properly then you cannot perform Dynamic Analysis with MobSF VM.
* **Getting the Host/Proxy IP**
  * **Windows** : Issue the command `ipconfig` in command prompt and note down the IP corresponding to the name of the Host-only Adapter.

    ![ipconfig example windows](https://cloud.githubusercontent.com/assets/4301109/9769557/8fdcf3d2-5748-11e5-905e-927159ea525b.png)

  * **Unix** : Issue the command `ifconfig` in terminal and note down the IP corresponding to the name of the Host-only Adapter.

    ![ifconfig example in mac](https://cloud.githubusercontent.com/assets/4301109/9769553/88bb329e-5748-11e5-9e91-3d14db839771.png)
    
   **NOTE**: The VirtualBox Host-Only Adapter IP and MobSF VM IP should be in the same network range. If your MobSF VM IP and Adapter IP are in different network range, modify the Adapter IP to be in the same network range as that of MobSF VM IP. 

   See: [What to do when MobSF VM and VirtualBox Host Only Adapter are not in the same network range](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/6.-What-to-do-when-MobSF-VM-and-VirtualBox-Host-Only-Adapter-are-not-in-the-same-network-range)
* Go to Wi-Fi Settings in **MobSF VM** and set the Proxy IP as the Host/Proxy IP which you have obtained from the previous step and port no as `1337`.

  ![Proxy Settings in VM](https://cloud.githubusercontent.com/assets/4301109/9769738/92961788-5749-11e5-98ac-26488ca46516.png)

* Save the settings and Navigate to the Home Screen of  **MobSF VM**. Wait for 30 seconds and save a snapshot of the **MobSF VM** in VirtualBox

  ![Saving MobSF VM Snapshot](https://cloud.githubusercontent.com/assets/4301109/9769841/26555556-574a-11e5-9de2-c7eb8b0f30bf.png)

* Once the Snapshot is saved, right click **MobSF VM** and select `Show in Explorer` or `Show in Finder`.
 
 ![Show VM Files](https://cloud.githubusercontent.com/assets/4301109/9769901/83c30b3e-574a-11e5-8f90-6ac02732429a.png)

* Open the File **MobSF_VM_X.X.vbox** in any Text Editor and note down the VM UUID and Snapshot UUID

 ![Getting VM UUID and Snapshot UUID](https://cloud.githubusercontent.com/assets/4301109/9769959/e9d9bb0c-574a-11e5-8005-730306445be9.png) 
  
  Here the value of `uuid` is the **VM UUID** and `currentSnapshot` is the **Snapshot UUID**.

* Now we have all the things needed to configure the Dynamic Analyzer (Host/Proxy IP, VM IP, VM UUID and Snapshot UUID)

* Go to `MobSF/settings.py` and set the appropriate values as

  * UUID = VM UUID
  * SUUID = Snapshot UUID
  * VM_IP = VM IP
  * PROXY_IP = Host/Proxy IP 
* In `MobSF/settings.py`, set `ANDROID_DYNAMIC_ANALYZER = "MobSF_VM"` (default)
* This will configure MobSF to use Android VirtualBox VM for Dynamic Analysis.

### Configuring Dynamic Analyzer with with MobSF Android 4.1.2 arm Emulator

* Make sure [Android Studio](https://developer.android.com/studio/index.html) is installed and an AVD is created. (Nexus 5 with Lollipop image is recommended) 
* Extract [MobSF_ARM_Emulator.zip](https://goo.gl/LRrGs3)
* Run `mobsfy_AVD.py` script and specify the directory that contains the files extracted from `MobSF_ARM_Emulator.zip`.
* In `MobSF/settings.py`, set `ANDROID_DYNAMIC_ANALYZER = "MobSF_AVD"`
* This will configure MobSF to use Android arm Emulator for Dynamic Analysis.

#### Manual Configuration (not recommended)
* If `mobsfy_AVD.py` script is not running successfully, you need to set the values for `AVD_EMULATOR` and `AVD_PATH` in `MobSF/settings.py` manually.
*  Follow the README inside the emulator zip and change all the path fields according to your system
* edit `MobSF/settings.py` and modify
```
AVD_EMULATOR = r'/Users/[USERNAME]/Library/Android/sdk/tools/emulator'
# This can be /Users/[USERNAME]/Library/Android/Sdk/emulator/emulator for newer versions of android SDK
 AVD_PATH = r'/Users/[USERNAME]/.android/avd'  # Path to the avd folder where you extracted the emulator
```
* In `MobSF/settings.py`, set `ANDROID_DYNAMIC_ANALYZER = "MobSF_AVD"`

### Configuring Dynamic Analyzer with Rooted Android 4.03 - 4.4 Device 

   * MobSFy the Rooted Android Device, Follow the instructions here: [Configure MobSF Dynamic Analysis Environment in Android Device](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/2.-Configure-MobSF-Dynamic-Analysis-Environment-in-your-Android-Device-or-VM)
  * In `MobSF/settings.py`, set `ANDROID_DYNAMIC_ANALYZER = "MobSF_REAL_DEVICE"`
  * Set `DEVICE_IP` and `DEVICE_ADB_PORT` with the IP and PORT that you got from WiFi ADB

### Configuring Dynamic Analyzer with Rooted Android 4.03 - 4.4 VM

  * MobSFy the Custom VM, Follow the instructions here: [Configure MobSF Dynamic Analysis Environment in Custom VM](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/2.-Configure-MobSF-Dynamic-Analysis-Environment-in-your-Android-Device-or-VM)
  *  **VM on Virtual Box**: If the VM is hosted on VirtualBox, follow the same steps that you have followed for configuring [MobSF x86 VirtualBox VM](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/1.-Documentation#configuring-dynamic-analyzer-with-mobsf-android-442-x86-virtualbox-vm) and set appropriate `VM  UUID`, `Snapshot UUID`, `Host/Proxy IP`, `VM IP` and set `ANDROID_DYNAMIC_ANALYZER = "MobSF_VM"`
  * **Any Other VM**: Configure it as a Real device. Set `ANDROID_DYNAMIC_ANALYZER = "MobSF_REAL_DEVICE"` and specify `DEVICE_IP`and `DEVICE_ADB_PORT`. Snapshot feature is only available with VM(s) hosted in VirtualBox.

***

## Updating MobSF

If you are updating MobSF, In most cases you might have to perform database migrations or you will see errors such as
```
[ERROR] Saving to DB (E:\Mobile-Security-Framework-MobSF\StaticAnalyzer\views\android\db_interaction.py, LINE 236 "static_db.save()"): table StaticAnalyzer_staticanalyzerandroid has no column named 
```

Run the below command to migrate your db
```
python manage.py makemigrations
python manage.py migrate
```

If the above changes didn't work, you might need to delete the file `db.sqlite3`, or run `clean.sh` in Mac/Linux. After that run the above commands.

NOTE: This will remove the previously saved MobSF scan results.

***
## Disabled Components

Some components are disabled by default as they are experimental 
### APKiD 

APKiD is disabled by default. Before enabling you will have to install the rednaga fork of yara-python.

```
git clone https://github.com/rednaga/yara-python
cd yara-python
python setup.py install
```
Enable APKiD in `settings.py` by setting `APKID_ENABLED` to `True`.
## Mass Static Analysis

MobSF supports mass static analysis: 
[Run Mass Static Analysis with MobSF](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/4.-Mass-Static-Analysis)

## Using Postgres DB instead of SQLite:

[How to Configure Postgres DB](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/8.-Use-Postgres-Database-Instead-of-Sqlite3)

## Home Directory Support

If you want all user uploads, downloads and user configurations to be created in home directory, enable home directory support: [Home Directory Support](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/5.-Home-Directory-Support)

## Docker Image for MobSF Static Analysis

[Dockerfile and Docker Image](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/7.-Docker-Container-for-MobSF-Static-Analysis)

## REST API

MobSF REST API Docs: [API Docs](https://github.com/MobSF/Mobile-Security-Framework-MobSF/wiki/3.-REST-API-Documentation)

## Running Tests

* Basic Static Analyzer unit tests - run MobSF and navigate to `http://127.0.0.1:8000/runtest/`
* MobSF REST API unit tests - run MobSF and navigate to `http://127.0.0.1:8000/runapitest/`